#!/usr/bin/python3

#
# Copyright (C) 2022 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-2.0-only
#

import fwutils

(u, data) = fwutils.init("dns.json")

# Setup hostname
fqdn = f'{data["general"]["hostname"]}.{data["general"]["domain"]}'
for section in u.get("system"):
    if  u.get("system", section) == "system":
        fwutils.vprint(f"Setting FQDN {fqdn}")
        u.set("system", section, "hostname", fqdn)
        del data["general"]["hostname"] # avoid to set an unsupported option in the next loop

dnsmasq_section = ''
# Set global options
for section in u.get("dhcp"):
    if  u.get("dhcp", section) == "dnsmasq":
        dnsmasq_section = section # for later use
        for o in data['general']:
            fwutils.vprint(f"Setting DNS option {o}")
            u.set("dhcp", section, o, data['general'][o])

        fwutils.vprint(f"Setting DNS forwardings")
        u.set("dhcp", section, "server", data["forwardings"])
        u.set("dhcp", section, "local", f'/{data["general"]["domain"]}/')


# Create hosts entries
for host in data["hosts"]:
    hname = fwutils.sanitize(host["name"])
    fwutils.vprint(f'Creating host {hname}')
    u.set("dhcp", hname, "domain") # create named record
    for o in host:
        u.set("dhcp", hname, o, host[o])

# Create wildcard hosts
addresses = []
for address in data["addresses"]:
    aname = fwutils.sanitize(address["name"])
    fwutils.vprint(f'Creating wildcard record {aname}')
    addresses.append(f'/{address["name"]}/{address["ip"]}')
u.set("dhcp", dnsmasq_section, "address", addresses)

# Save configuration
u.commit("dhcp")
u.commit("system")
