#!/usr/bin/python3

import fwutils

(u, data) = fwutils.init("dns.json")

# Setup hostname
fqdn = f'{data["general"]["hostname"]}.{data["general"]["domain"]}'
for section in u.get("system"):
    if  u.get("system", section) == "system":
        fwutils.vprint(f"Setting FQDN {fqdn}")
        u.set("system", section, "hostname", fqdn)
        del data["general"]["hostname"] # avoid to set an unsupported option in the next loop

# Set global options
for section in u.get("dhcp"):
    if  u.get("dhcp", section) == "dnsmasq":
        for o in data['general']:
            fwutils.vprint(f"Setting DNS option {o}")
            u.set("dhcp", section, o, data['general'][o])

        fwutils.vprint(f"Setting DNS forwardings")
        u.set("dhcp", section, "server", data["forwardings"])
        u.set("dhcp", section, "local", f'/{data["general"]["domain"]}/')


# Create hosts entries
for host in data["hosts"]:
    hname = fwutils.sanitize(host["name"])
    fwutils.vprint(f'Creating host {hname}')
    u.set("dhcp", hname, "domain") # create named record
    for o in host:
        u.set("dhcp", hname, o, host[o])

# Save configuration
u.commit("dhcp")
u.commit("system")
